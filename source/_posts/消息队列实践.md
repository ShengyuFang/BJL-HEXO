---
title: 消息队列
date: 2022-10-05 13:09:00
categories: 工作
---
### 消息队列的优点：
1. 解耦请求与处理逻辑。
2. 附带了持久化功能，防止请求丢失。
### 场景
消息队列的本质还是异步处理。适用的场景有秒杀、短信邮件通知、数据统计、监控、数据同步，分布式事务，广告计费，库存扣减以及相似业务，实时性、一致性要求没那么高的业务。不适合的场景有转账（其实也用消息队列，取决于具体业务，有些银行接口需要秒级才能返回，不得不异步化），以及非必要不使用消息队列，因为消息队列会增加系统维护成本，增加延迟。
**不适合消息队列的案例**：银行转账。转账本质是个分布式事务问题，需要保证流水和余额严格一致，所以并不适合用事务消息来解决，某大厂采用TCC方案处理事务。即使非要用事务消息来解决，也应该先在数据库事务中记录流水，再异步更新余额。这样，即使出现数据不一致的问题，也可以用流水来更正余额。反过来，没有办法通过余额反推出流水记录的。
### 实践步骤
1. Kafka,RocketMQ,RabbitMQ都不能保证在“从消息生产直到消费完成”这个过程中，消息不重不丢（Exactly once）
2. 请求处理是否需要有序? Kafka保证了同一分区内数据有序。
3. 请求处理防重复、幂等。导致数据处理重复的原因有：发送消息重试，处理消息重试，异步提交失败，消息队列内部重分区。幂等的实现方式有：依靠数据库主键、唯一ID、记录表、版本号、状态更新、锁等。
4. 给消息队列开启死信队列，以便可以恢复数据。
5. 监控消息堆积、死信队列、消息延迟等，最尴尬的是有些请求未处理并且没发现。
6. 数据安全要求非常高再加上离线审计。实际工作里需要对齐各组数据，繁琐。